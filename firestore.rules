rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - users can only access their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Contextos collection - users can only access contextos they're responsible for
    match /contextos/{contextoId} {
      allow read: if request.auth != null && (
        resource.data.responsableId == request.auth.uid ||
        request.auth.token.admin == true
      );
      allow create: if request.auth != null && 
        request.resource.data.responsableId == request.auth.uid;
      allow update: if request.auth != null && (
        resource.data.responsableId == request.auth.uid ||
        request.auth.token.admin == true
      );
      allow delete: if request.auth != null && (
        resource.data.responsableId == request.auth.uid ||
        request.auth.token.admin == true
      );
    }

    // Commits collection - read access based on contexto ownership
    match /commits/{commitId} {
      allow read: if request.auth != null && (
        exists(/databases/$(database)/documents/contextos/$(resource.data.contextoId)) &&
        get(/databases/$(database)/documents/contextos/$(resource.data.contextoId)).data.responsableId == request.auth.uid ||
        request.auth.token.admin == true
      );
      allow write: if request.auth.token.service == true; // Only service accounts can write commits
    }

    // Analysis collection - read access based on commit ownership
    match /analysis/{analysisId} {
      allow read: if request.auth != null && (
        exists(/databases/$(database)/documents/commits/$(resource.data.commitId)) &&
        request.auth.token.admin == true
      );
      allow write: if request.auth.token.service == true; // Only service accounts can write analysis
    }

    // Jobs collection - restricted to admin and service accounts
    match /jobs/{jobId} {
      allow read, write: if request.auth != null && (
        request.auth.token.admin == true ||
        request.auth.token.service == true
      );
    }

    // Webhook events - service accounts only
    match /webhook_events/{eventId} {
      allow read, write: if request.auth.token.service == true;
    }

    // System configuration - admin only
    match /system/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // Migrations - service accounts only
    match /_migrations/{migrationId} {
      allow read, write: if request.auth.token.service == true;
    }

    // Default deny rule
    match /{document=**} {
      allow read, write: if false;
    }
  }
}